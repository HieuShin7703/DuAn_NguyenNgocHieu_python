<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cấu hình - Crawler</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h5 {
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }
    table tbody tr:hover {
      background-color: #e2f0ff;
    }
    .btn-primary {
      transition: all 0.3s;
    }
    .btn-primary:hover {
      background-color: #00f2fe;
      color: #fff;
    }
    .modal .form-control {
      margin-bottom: 0.8rem;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-info">
  <div class="container-fluid">
    <a class="navbar-brand" href="dashboard.html"><i class="fas fa-cogs me-2"></i>Crawler Config</a>
  </div>
</nav>

<div class="container my-4">
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Data Sources</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="sourcesTable">
            <thead class="table-light">
              <tr><th>#</th><th>Name</th><th>Base URL</th><th>Status</th><th>Hành động</th></tr>
            </thead>
            <tbody>
              <!-- demo row -->
              <tr>
                <td>1</td>
                <td>Shop Shopee</td>
                <td>https://shopee.vn</td>
                <td><span class="badge bg-success">Active</span></td>
                <td>
                  <button class="btn btn-sm btn-primary"><i class="fas fa-edit me-1"></i>Sửa</button>
                  <button class="btn btn-sm btn-danger"><i class="fas fa-trash-alt me-1"></i>Xóa</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button id="addSourceBtn" class="btn btn-primary mt-2"><i class="fas fa-plus me-1"></i>Thêm Source</button>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5>Shops</h5>
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="shopsTable">
            <thead class="table-light">
              <tr><th>#</th><th>Name</th><th>Platform ID</th><th>URL</th><th>Hành động</th></tr>
            </thead>
            <tbody>
              <!-- demo row -->
              <tr>
                <td>1</td>
                <td>Shop ABC</td>
                <td>shopee_001</td>
                <td>https://shopee.vn/shop/abc</td>
                <td>
                  <button class="btn btn-sm btn-primary"><i class="fas fa-edit me-1"></i>Sửa</button>
                  <button class="btn btn-sm btn-danger"><i class="fas fa-trash-alt me-1"></i>Xóa</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button id="addShopBtn" class="btn btn-primary mt-2"><i class="fas fa-plus me-1"></i>Thêm Shop</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Source/Shop -->
<div class="modal fade" id="simpleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="simpleForm">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm Source/Shop</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalBody">
          <input type="text" id="itemName" class="form-control" placeholder="Name" required>
          <input type="text" id="itemUrl" class="form-control" placeholder="Base URL / Shop URL">
          <input type="text" id="itemPlatform" class="form-control" placeholder="Platform ID (Shop)">
          <select id="itemStatus" class="form-select">
            <option>Active</option>
            <option>Inactive</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-primary" type="submit"><i class="fas fa-save me-1"></i>Lưu</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const simpleModalEl = document.getElementById('simpleModal');
const simpleModal = new bootstrap.Modal(simpleModalEl);

function loadSources(){
  $.get('../api/datasources.php').done(function(sources){
    const tbody = $('#sourcesTable tbody').empty();
    sources.forEach((s,i)=> {
      tbody.append(`<tr>
        <td>${i+1}</td><td>${s.name}</td><td>${s.base_url}</td><td>${s.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary editSource" data-id="${s.source_id}">Edit</button>
          <button class="btn btn-sm btn-outline-danger delSource" data-id="${s.source_id}">Del</button>
        </td>
      </tr>`);
    });
  });
}

function loadShops(){
  $.get('../api/shops.php').done(function(shops){
    const tbody = $('#shopsTable tbody').empty();
    shops.forEach((s,i)=> {
      tbody.append(`<tr>
        <td>${i+1}</td><td>${s.shop_name}</td><td>${s.platform_shop_id}</td><td><a target="_blank" href="${s.shop_url}">${s.shop_url}</a></td>
        <td>
          <button class="btn btn-sm btn-outline-primary editShop" data-id="${s.shop_id}">Edit</button>
          <button class="btn btn-sm btn-outline-danger delShop" data-id="${s.shop_id}">Del</button>
        </td>
      </tr>`);
    });
  });
}

$(function(){
  loadSources(); loadShops();

  $('#addSourceBtn').on('click', function(){
    $('#modalTitle').text('Thêm Data Source');
    $('#modalBody').html(`
      <input type="hidden" id="source_id">
      <div class="mb-2"><label>Name</label><input id="ds_name" class="form-control" required></div>
      <div class="mb-2"><label>Base URL</label><input id="ds_base_url" class="form-control"></div>
      <div class="mb-2"><label>Status</label><select id="ds_status" class="form-control"><option>Inactive</option><option>Active</option></select></div>
    `);
    simpleModal.show();
  });

  $('#addShopBtn').on('click', function(){
    $('#modalTitle').text('Thêm Shop');
    $('#modalBody').html(`
      <input type="hidden" id="shop_id">
      <div class="mb-2"><label>Platform Shop ID</label><input id="shop_platform_id" class="form-control"></div>
      <div class="mb-2"><label>Shop name</label><input id="shop_name" class="form-control" required></div>
      <div class="mb-2"><label>Shop URL</label><input id="shop_url" class="form-control"></div>
      <div class="mb-2"><label>Source ID</label><input id="shop_source_id" class="form-control" placeholder="source_id (optional)"></div>
    `);
    simpleModal.show();
  });

  // submit create/edit generic
  $('#simpleForm').on('submit', function(e){
    e.preventDefault();
    // decide if modal is for source or shop by presence of inputs
    if($('#ds_name').length){
      const payload = { name: $('#ds_name').val(), base_url: $('#ds_base_url').val(), status: $('#ds_status').val() };
      const id = $('#source_id').val();
      if(!id){
        $.ajax({ url: '../api/datasources.php', method: 'POST', contentType:'application/json', data: JSON.stringify(payload), success: function(r){ simpleModal.hide(); loadSources(); alert(r.message);} });
      } else {
        payload.source_id = id;
        $.ajax({ url: '../api/datasources.php', method: 'PUT', contentType:'application/json', data: JSON.stringify(payload), success: function(r){ simpleModal.hide(); loadSources(); alert(r.message);} });
      }
    } else {
      const payload = { platform_shop_id: $('#shop_platform_id').val(), shop_name: $('#shop_name').val(), shop_url: $('#shop_url').val(), source_id: $('#shop_source_id').val() || null };
      const id = $('#shop_id').val();
      if(!id){
        $.ajax({ url: '../api/shops.php', method: 'POST', contentType:'application/json', data: JSON.stringify(payload), success: function(r){ simpleModal.hide(); loadShops(); alert(r.message);} });
      } else {
        payload.shop_id = id;
        $.ajax({ url: '../api/shops.php', method: 'PUT', contentType:'application/json', data: JSON.stringify(payload), success: function(r){ simpleModal.hide(); loadShops(); alert(r.message);} });
      }
    }
  });

  // edit / delete handlers
  $(document).on('click','.editSource', function(){
    const id = $(this).data('id');
    $.get('../api/datasources.php', { id }).done(function(s){
      $('#modalTitle').text('Edit Data Source');
      $('#modalBody').html(`
        <input type="hidden" id="source_id" value="${s.source_id}">
        <div class="mb-2"><label>Name</label><input id="ds_name" class="form-control" value="${s.name}"></div>
        <div class="mb-2"><label>Base URL</label><input id="ds_base_url" class="form-control" value="${s.base_url}"></div>
        <div class="mb-2"><label>Status</label><select id="ds_status" class="form-control"><option ${s.status==='Inactive'?'selected':''}>Inactive</option><option ${s.status==='Active'?'selected':''}>Active</option></select></div>
      `);
      simpleModal.show();
    });
  });

  $(document).on('click','.delSource', function(){
    if(!confirm('Xóa source?')) return;
    const id = $(this).data('id');
    $.ajax({ url: '../api/datasources.php', method:'DELETE', data: { id }, success: function(r){ alert(r.message); loadSources(); } });
  });

  $(document).on('click','.editShop', function(){
    const id = $(this).data('id');
    $.get('../api/shops.php', { id }).done(function(s){
      $('#modalTitle').text('Edit Shop');
      $('#modalBody').html(`
        <input type="hidden" id="shop_id" value="${s.shop_id}">
        <div class="mb-2"><label>Platform Shop ID</label><input id="shop_platform_id" class="form-control" value="${s.platform_shop_id}"></div>
        <div class="mb-2"><label>Shop name</label><input id="shop_name" class="form-control" value="${s.shop_name}"></div>
        <div class="mb-2"><label>Shop URL</label><input id="shop_url" class="form-control" value="${s.shop_url}"></div>
      `);
      simpleModal.show();
    });
  });

  $(document).on('click','.delShop', function(){
    if(!confirm('Xóa shop?')) return;
    const id = $(this).data('id');
    $.ajax({ url: '../api/shops.php', method:'DELETE', data: { id }, success: function(r){ alert(r.message); loadShops(); } });
  });

});
</script>
</body>
</html>
